- content_for :sidebar do
  %h3 Search
  = render :partial => 'shared/end_counts_search_form', locals: { search_path: '/directional' }

.block
  = render 'shared/menu/reports'
  .content
    .title_action_bar
      %h2.title= directional_reports_title(params[:date], params[:date])
      .new_actions
        = 'Download as'
        = link_to 'CSV', :format => :csv
        = link_to 'PDF', :format => :pdf
    .inner
      %table
        %tr
          %th Net Sales (Category)
          %th &nbsp;
          %th Percentage
        - directional_categories_percentage = Array.new
        - last_year = @directional.last_year
        - @directional.net_sales.each do |category, net_sale|
          %tr
            %td= category
            %td.monetary= number_to_currency(net_sale, :unit => peso_sign)
            - amount_percentage = net_sale.to_f.percent_of(@directional.net_sale_total)
            - directional_categories_percentage << amount_percentage
            %td=  number_to_percentage(amount_percentage, :precision => 2)
        %tr.totals
          %td= 'Total'
          %td.monetary= number_to_currency(@directional.net_sale_total, :precision => 2, :unit => peso_sign)
          %td= number_to_percentage(directional_categories_percentage.inject(:+), :precision => 2)
        %tr
          %th Net Sales
          %th{:title => 'Month to Date', :class => 'number'} MTD
          %th.number Last year
        %tr.totals
          %td= 'Total'
          %td.monetary= number_to_currency(@directional.net_sale_total, :precision => 2, :unit => peso_sign)
          %td.monetary= number_to_currency(last_year.net_sale_total, :precision => 2, :unit => peso_sign)
        %tr
          %td Customer Count
          %td.number= number_with_precision(@directional.customer_count, :precision => 2, :delimiter => ',')
          %td.number= number_with_precision(last_year.customer_count, :precision => 2, :delimiter => ',')
        %tr
          %td Per Person Ave
          %td.number= number_with_precision(@directional.per_person_ave, :precision => 2, :delimiter => ',')
          %td.number= number_with_precision(last_year.per_person_ave, :precision => 2, :delimiter => ',')
        %tr
          %td Transaction Count
          %td.number= number_with_precision(@directional.transaction_count, :precision => 2, :delimiter => ',')
          %td.number= number_with_precision(last_year.transaction_count, :precision => 2, :delimiter => ',')
        %tr
          %td Per Transaction Ave
          %td.number= number_with_precision(@directional.per_trans_ave, :precision => 2, :delimiter => ',')
          %td.number= number_with_precision(last_year.per_trans_ave, :precision => 2, :delimiter => ',')
      
      %table{:title => 'Settlement Types'}
        %tr
          %th Complimentary Analysis
          %th MTD
          %th % To NET SALES
        - @settlement_type.each do |st| 
          - settlement_type_sales_amount = st.settlement_type_sales.map(&:amount).reject(&:nil?).inject(:+).to_f || 0
          - settlement_type_sales_percentage = (settlement_type_sales_amount / @directional.net_sale_total) * 100
          %tr
            %td= st.name
            %td.monetary= number_with_precision(st.settlement_type_sales.map(&:amount).reject(&:nil?).inject(:+).to_f || 0, :precision => 2, :delimiter => ',')
            %td= number_to_percentage(settlement_type_sales_percentage, :precision => 2)
      
      %table{:title => 'Cost of Goods'}
        %tr
          %th Cost of Goods
          %th.number Beggining
          %th.monetary Purchase
          %th.number Purchase %
          %th.number Ending
          %th.number COGS
          %th.number COGS %
          %th.number Goal %
          %th.number VAR +/-
        - @directional.cogs.each do |c|
          %tr
            %td= c.name
            %td.number= number_with_precision(c.beginning, :precision => 2, :delimiter => ',')
            %td.monetary= number_to_currency(c.purchase, :unit => peso_sign)
            %td.number= number_to_percentage(c.purchase_perc, :precision => 2)
            %td.number= number_with_precision(c.ending, :precision => 2, :delimiter => ',')
            %td.number= number_with_precision(c.cogs, :precision => 2, :delimiter => ',')
            %td.number= number_to_percentage(c.cogs_perc, :precision => 2)
            %td.number= number_to_percentage(c.subcategory.goal, :precision => 2)
            %td.number= number_to_percentage(c.var_perc, :precision => 2)
