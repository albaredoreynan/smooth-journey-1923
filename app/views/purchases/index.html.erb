
<div class="left"> 
<h2><a href="#">VIEW PURCHASES</a></h2>
<hr />
<br/>
</div>

<div class="right"></div>
<div style="clear: both;"></div>

<%= form_tag '/purchases/search' do %>
<table>
	<tr>
		<td>From</td>
		<td><%= date_select(:start, '', :start_year => 2010) %></td>
	</tr>
	<tr>
		<td>To</td>
		<td><%= date_select(:end, '', :start_year => 2010) %></td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td><%= submit_tag :Search %></td>
	</tr>
</table>

<% end %>

<table border="1" width="1000">
  <tr>
  	<th></th>
    <th>Invoice number</th>
    <th>Invoice date</th>
    <th>Supplier</th>
    <th>Branch</th>
    <th>Category</th>
    <th>Subcategory</th>
    <th>Inventory item</th>
    <th>Purchase quantity</th>
    <th>Purchase Unit</th>
	<th>Purchase Unit Cost</th>
	<th>Inventory Quantity</th>
	<th>Inventory Unit</th>
	<th>Inventory Unit Cost</th>
	<th>Purchase Amount</th>
	<th>VAT-Type</th>
	<th>VAT-Amount</th>
	<th>Net-Amount</th>
    <th>Invoice total</th>
    <th>Show</th>
    <th>Edit</th>
  </tr>
  
<% totalamount = 0 %>
<% totalnet = 0 %>
<% totalvat = 0 %>

<%= form_tag '/purchases/savemultiple' do %>

<% @purchases.each do |purchase| %>
	<% for purchaserow in purchase.purchaserows %>
  <tr>
  	<td><center><% if purchase.save_as_draft == 1 %>
    	<%= check_box_tag "purchase_ids[]", purchase.id %>
    	<% end %></center></td>
    <% purchase.created_at.strftime("%B %d, %Y") %>
    <td><%= purchase.invoice_id %></td>
    <td><%= purchase.purchase_date.strftime("%B %d, %Y") %></td>
    
    <td><% supplierId = purchase.supplier_id %>
    	<% s = Supplier.find(supplierId) %>
    	<%= s.supplier_name %>
    </td>
    <td><% branchId = purchase.branch_id %>
    	<% b = Branch.find(branchId) %>
    	<%= b.branch_location %>
    </td>
    
    
    
    <% itemId = purchaserow.inventoryitem_id %>
    <% i = Inventoryitem.find(itemId)%>
    <% subcatId = i.subcategory_id %>
    <% s = Subcategory.find(subcatId) %>
    <% catId = s.category_id %>
    <% c = Category.find(catId) %>
    <td><%= c.category_name %></td>
    <td><%= s.subcategory_name %></td>
    <td>
			<%=h i.item_name %>
		</td>
	<td><%=h number_with_precision(purchaserow.purchase_quantity, :precision => 0) %></td>
    <td><% unitId1 = purchaserow.purchase_unit %>
			<% u = Unit.find(unitId1) %>
			<% unit1 = u.unit_name %>
			<%=h unit1 %>
		</td>
		<td><%=h number_with_precision(purchaserow.purchase_unitCost, :precision => 2) %></td>
		<% q = purchaserow.purchase_quantity %>
		<% i = Inventoryitem.find(itemId) %>
		<% unitId2 = i.unit_id %>
		<% u = Unit.find(unitId2) %>
		<% unit2 = u.unit_name %>
		<td>
		<% if unitId1==unitId2 %>
			<%=h number_with_precision(purchaserow.purchase_quantity, :precision => 0) %>
		<% else %>
			<% temp1 = Conversion.where("b_unit = ? and s_unit = ?",unitId1,unitId2) %>
			<% temp2 = Conversion.where("b_unit = ? and s_unit = ?",unitId2,unitId1) %>
			
			<% if temp1.count>0 %>
				<% conversion_num = temp1.first.conversionNumber %>
				<% inventory_quantity = q*(1/(1/conversion_num)) %>
				<%= inventory_quantity %>
			<% else %>
				<% if temp2.count>0 %>
					<% conversion_num = temp2.first.conversionNumber %>
					<% inventory_quantity = q*(1/conversion_num) %>
					<%= inventory_quantity %>
				<% end %>
			<% end %>
		<% end %>
		</td>
		<td><%= unit2 %></td>
		<td><%= unit1 %> and <%= unit2 %></td>

    <% number_with_precision(purchaserow.purchase_unitCost, :precision => 2) %>
    <td><%= number_with_precision(purchaserow.purchase_amount, :precision => 2) %></td>
    
    <% totalamount = totalamount + purchaserow.purchase_amount %>
    
    <td><%= purchaserow.vat_type %></td>
    <td><%= number_with_precision(purchaserow.vat_amount, :precision => 2) %></td>
    
    <% totalvat = totalvat + purchaserow.vat_amount %>
    
    <td><%= number_with_precision(purchaserow.net_amount, :precision => 2) %></td>
   <% totalnet = totalnet + purchaserow.net_amount %>
   
   <% invoicetotal = 0 %>
   <td><% @p = Purchaserow.where(:purchase_id => purchase.id) %>
   	<% @p.each do |purchaserow| %>
   	<% invoicetotal = invoicetotal + purchaserow.purchase_amount %>
   	
   	<% end %><%= number_with_precision(invoicetotal, :precision => 2) %></td>
   
    <td><%= link_to 'Show', purchase %></td>
    <td><% if purchase.save_as_draft == 1 %><%= link_to 'Edit', edit_purchase_path(purchase) %><% end %></td>
    <!-- <td><% if purchase.save_as_draft == 1 %><%= link_to 'Destroy', purchase, :confirm => 'Are you sure?', :method => :delete %><% end %></td> -->
     
  </tr>
  <% end %>
<% end %>

	<tr>
		<td><%= submit_tag 'Submit records' %><%= submit_tag 'Delete records ' %></td> <!-- select checkboxes na checked-->
	    <td><center><b>Total</b></center></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    
	    <td><b><%= number_with_precision(totalamount, :precision => 2) %></b></td>
	    <td></td>
	    <td><b><%= number_with_precision(totalvat, :precision => 2) %></b></td>
	    <td><b><%= number_with_precision(totalnet, :precision => 2) %></b></td>
	    <td><b><%= number_with_precision(totalamount, :precision => 2) %></b></td>
	    <td></td>
	    <td></td>
	</tr>
</table>
<br />
<% end %>

<%= link_to 'New purchase', new_purchase_path %>
