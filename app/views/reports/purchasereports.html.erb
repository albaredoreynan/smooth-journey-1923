<div class="left"> 
<h2><a href="#">PURCHASE REPORTS</a></h2>
<hr />
<br/>
</div>


<div class="right"></div>
<div style="clear: both;"></div>

<%= form_tag '/purchasereports/search' do %>
<table>
	<tr>
		<td>From</td>
		<td><%= date_select(:start, '', :start_year => 2010) %></td>
	</tr>
	<tr>
		<td>To</td>
		<td><%= date_select(:end, '', :start_year => 2010) %></td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td><%= submit_tag :Search %></td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td>Supplier</td>
		<td><%= collection_select(:supplier, :supplier_id, Supplier.all, :id, :supplier_name, :prompt => true)%></td>
		<td>Invoice number</td>
		<td><%= text_field(:invoice_number, "Invoice number", :style => "width:100px") %></td>
		<td>Category</td>
		<td><%= collection_select(:category, :category_id, Category.all, :id, :category_name, :prompt => true)%></td>
		<td>Subategory</td>
		<td><%= collection_select(:subcategory, :subcategory_id, Subcategory.all, :id, :subcategory_name, :prompt => true)%></td>
		<td>Item</td>
		<td><%= collection_select(:inventoryitem, :inventoryitem_id, Inventoryitem.all, :id, :item_name, :prompt => true)%></td>
	
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td><%= submit_tag "Search by supplier" %></td>
		<td>&nbsp;</td>
		<td><%= submit_tag "Search by invoice" %></td>
		<td>&nbsp;</td>
		<td><%= submit_tag "Search by category" %></td>
		<td>&nbsp;</td>
		<td><%= submit_tag "Search by subcategory" %></td>
		<td>&nbsp;</td>
		<td><%= submit_tag "Search by item" %></td>
	</tr>
</table>
<% end %>
<br />
<table border="1" width="1000">
  <tr>
    <th>Purchase date</th>
    <th>Invoice</th>
    <th>Supplier</th>
    <th>Branch</th>
    <th>Item</th>
	<th>Quantity</th>
	<th>Unit</th>
	<th>Unit Cost</th>
	<th>Quantity</th>
	<th>Unit</th>
	<th>Unit Cost</th>
	<th>Amount</th>
	<th>VAT-Type</th>
	<th>VAT-Amount</th>
	<th>Net-Amount</th>
	<th>Invoice total</th>
  </tr>
  
<% totalamount = 0 %>
<% totalnet = 0 %>
<% totalvat = 0 %>

<% @purchases.each do |purchase| %>
	<% for purchaserow in purchase.purchaserows %>
	  <tr>
		<td><%= purchase.purchase_date.strftime("%B %d, %Y")  %></td>
		<td><%= purchase.invoice_id %></td>
		<td><% supplierId = purchase.supplier_id %>
			<% s = Supplier.find(supplierId) %>
			<%= s.supplier_name %>
		</td>
		<td><% branchId = purchase.branch_id %>
			<% b = Branch.find(branchId) %>
			<%= b.branch_location %>
		</td>
		<td><% itemId = purchaserow.inventoryitem_id %>
			<% i = Inventoryitem.find(itemId) %>
			<%=h i.item_name %>
		</td>
		<td><%=h number_with_precision(purchaserow.purchase_quantity, :precision => 0) %></td>
		<td><% unitId1 = purchaserow.purchase_unit %>
			<% u = Unit.find(unitId1) %>
			<% unit1 = u.unit_name %>
			<%=h unit1 %>
		</td>
		<td><%=h number_with_precision(purchaserow.purchase_unitCost, :precision => 2) %></td>
		
		<% q = purchaserow.purchase_quantity %>
		<% i = Inventoryitem.find(itemId) %>
		<% unitId2 = i.unit_id %>
		<% u = Unit.find(unitId2) %>
		<% unit2 = u.unit_name %>
		<td>
		<% if unitId1==unitId2 %>
			<%=h number_with_precision(purchaserow.purchase_quantity, :precision => 0) %>
		<% else %>
			<% temp1 = Conversion.where("b_unit = ? and s_unit = ?",unitId1,unitId2) %>
			<% temp2 = Conversion.where("b_unit = ? and s_unit = ?",unitId2,unitId1) %>
			
			<% if temp1.count>0 %>
				<% conversion_num = temp1.first.conversionNumber %>
				<% inventory_quantity = q*(1/(1/conversion_num)) %>
				<%= inventory_quantity %>
			<% else %>
				<% if temp2.count>0 %>
					<% conversion_num = temp2.first.conversionNumber %>
					<% inventory_quantity = q*(1/conversion_num) %>
					<%= inventory_quantity %>
				<% end %>
			<% end %>
		<% end %>
		</td>
		<td><%= unit2 %></td>
		<td><%= unit1 %> and <%= unit2 %></td>
		<td><%=h number_with_precision(purchaserow.purchase_amount, :precision => 2) %></td>
		<td><%=h purchaserow.vat_type %></td>
		<td><%=h number_with_precision(purchaserow.vat_amount, :precision => 2) %></td>
		<td><%=h number_with_precision(purchaserow.net_amount, :precision => 2) %></td>
		
		<% totalamount = totalamount + purchaserow.purchase_amount %>
    	<% totalvat = totalvat + purchaserow.vat_amount %>
    	<% totalnet = totalnet + purchaserow.net_amount %>
    	<% invoicetotal = 0 %>
   <td><% @p = Purchaserow.where(:purchase_id => purchase.id) %>
   	<% @p.each do |purchaserow| %>
   	<% invoicetotal = invoicetotal + purchaserow.purchase_amount %>
   	
   	<% end %><%= number_with_precision(invoicetotal, :precision => 2) %></td>
	  </tr>
	<% end %>
<% end %>

  <tr>
  	
  	<td><b>Total</b></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td></td>
  	<td><b><%= number_with_precision(totalamount, :precision => 2) %></b></td>
  	<td></td>
  	<td><b><%= number_with_precision(totalvat, :precision => 2) %></b></td>
	<td><b><%= number_with_precision(totalnet, :precision => 2) %></b></td>
	<td><b><%= number_with_precision(totalamount, :precision => 2) %></b></td>
  </tr>
</table>
